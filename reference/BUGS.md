# Bugs

Pending:

Completed:
- ✅ When navigating to /scanner/ after a scan has already been run, Good/Bad pills were not displaying correctly
  - **Root Cause**: The `index()` view was not including `curated_stocks` in its context. When the template tried to use `{% with stock=curated_stocks|dict_get:ticker %}`, Django treated the missing variable as an empty string `""`, which then triggered the `dict_get` filter warning: "dict_get received non-dict type: str"
  - **Fixed**: Refactored `index()` view to use `get_scan_results()` helper function for consistent context across all views
  - **Files Changed**:
    - Modified: `scanner/views.py` (refactored `index()` view from ~65 lines to ~10 lines by using `get_scan_results()` helper)
    - Modified: `scanner/tests/test_scanner_views.py` (added 3 new tests + fixed 1 existing test mock, total 4 test changes)
  - **How it works**: The `index()` view now calls `get_scan_results()` which fetches both Redis options data AND CuratedStock instances from the database, ensuring `curated_stocks` and `is_local_environment` are always in the context. This provides DRY consistency with `scan_view()` and `scan_status()` views.
  - **Benefits**:
    - Good/Bad pills now display correctly on initial page load
    - Dev warning banner shows consistently in LOCAL environment
    - Code is DRY (Don't Repeat Yourself) - single source of truth for context building
    - Easier to maintain - changes to context structure only need to be made in one place
  - **Testing**: Added 3 comprehensive tests to verify `curated_stocks` is always a dict in context, never None or string. All 6 TestIndexView tests passing.
- ✅ Getting 'str' object has no attribute 'get' on options_results.html line 35 when Redis data expires
  - **Fixed**: Implemented hybrid defense-in-depth approach with backend validation + defensive template handling + Redis error recovery
  - **Files Changed**:
    - Modified: `scanner/views.py` (added try/except blocks for Redis operations in `get_scan_results()` and `index()` views, ensured `curated_stocks` always dict)
    - Modified: `scanner/templatetags/options_extras.py` (added type checking to `dict_get` and `lookup` filters with warning logs)
    - Created: `scanner/tests/test_template_filters.py` (18 unit tests for template filters - all passing)
    - Created: `scanner/tests/test_redis_integration.py` (8 integration tests for Redis failures - all passing)
    - Modified: `scanner/tests/test_scanner_views.py` (added 7 Redis error handling tests - 5 passing, 2 skipped due to test infrastructure)
  - **How it works**: 
    - **Backend Layer**: Views catch Redis exceptions (ConnectionError, TimeoutError, JSONDecodeError) and return safe defaults (empty dicts). The `get_scan_results()` function validates that `curated_stocks` is always a dictionary before returning context. Individual JSON decode errors are caught per-ticker and logged, allowing partial results.
    - **Template Layer**: The `dict_get` filter performs `isinstance()` check before calling `.get()`, returning None for non-dict inputs and logging warnings at WARNING level for debugging.
    - **UX Layer**: When Redis fails, users see "Data temporarily unavailable. Please refresh the page." message and gray "-" badges for stocks (indicating no valuation data). Application remains fully functional.
    - **Defense in depth**: Even if backend validation fails, template filter prevents crashes. Even if template filter fails, existing template logic handles None gracefully by showing gray badges.
    - **Testing**: 33 new tests (18 unit + 8 integration + 7 view tests) verify graceful degradation using Redis mocks. All tests use `@patch` mocks to avoid requiring actual Redis instance during testing.
- ✅ Getting "Reverse for 'scan' not found. 'scan' is not a valid view function or pattern name." when clicking on "Options Scanner" button or navigating to /scanner/
  - **Fixed**: Added missing namespace prefix to URL template tags
  - **Files Changed**:
    - Modified: `templates/scanner/index.html` (changed `{% url 'scan' %}` to `{% url 'scanner:scan' %}`)
    - Modified: `templates/scanner/partials/scan_polling.html` (changed `{% url 'scan_status' %}` to `{% url 'scanner:scan_status' %}`)
  - **How it works**: The scanner app uses `app_name = "scanner"` in `scanner/urls.py`, creating a URL namespace. All URL references must include this namespace prefix (e.g., `scanner:scan` instead of just `scan`). Without the namespace, Django's URL reverser cannot find the matching pattern.
- ✅ The login and logout pages are not using any styling.  They should match the styling of the main site.
  - **Fixed**: Created custom allauth templates with Flowbite/Tailwind styling
  - **Files Changed**:
    - Created: `templates/account/base.html` (minimal layout with logo and "Return to Home" link)
    - Created: `templates/account/login.html` (styled login form with Flowbite components)
    - Created: `templates/account/logout.html` (styled logout confirmation)
  - **How it works**: Django-allauth uses template override system. Templates in `templates/account/` take priority over built-in allauth templates. Auth pages use minimal layout (no navbar) with centered forms, matching site's Flowbite/Tailwind aesthetic.
- ✅ When clicking the "Scan for Options" button, the last run is immediately placed in the status banner.  It should not display the last run information, it should display the current status of the scan.
  - **Fixed**: Set initial status in `scan_view()` before rendering template, removed problematic `elif` clause from template, added completion timestamp
  - **Files Changed**:
    - Modified: `scanner/views.py` (added initial status setting, completion message with timestamp)
    - Modified: `templates/scanner/partials/scan_polling.html` (simplified status logic, removed old error display)
  - **How it works**: When scan starts, `last_run` is immediately set to "Scanning in progress..." before template renders. Template logic simplified to show progress or default message. On completion, timestamp is added: "Scan completed successfully at [timestamp]"
- ✅ The scanner url should only be accessible by logged in users.  Currently any user can navigate to /scanner/
  - **Fixed**: Added `@login_required` decorators to all scanner views
  - **Files Changed**:
    - Modified: `scanner/views.py` (added decorators to 4 views)
    - Modified: `wheel_analyzer/settings.py` (added LOGIN_URL configuration)
  - **How it works**: Django's `@login_required` decorator checks authentication and redirects to `/accounts/login/?next=/scanner/` for unauthenticated users. After login, users are redirected back to the page they originally tried to access.
- ✅ The accordion expansion is not working on the scan_polling.html partial. The user should be able to expand the accordion tab to see the details.
  - **Fixed**: Created `static/js/app.js` with HTMX `afterSwap` event listener that calls Flowbite's `initFlowbite()` function
  - **Files Changed**: 
    - Created: `static/js/app.js`
    - Modified: `templates/base.html` (added script tag)
  - **How it works**: When HTMX swaps content (after clicking "Scan for Options"), Flowbite's `initFlowbite()` is called to reinitialize all components including accordions, restoring full click functionality