{% extends "base.html" %}
{% load static %}

{% block title %}Valuation Comparison Report{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1" integrity="sha384-9nhczxUqK87bcKHh20fSQcTGD4qq5GhayNYSYWqwBkINBhOfQLg/P5HG5lF1urn4" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Valuation Comparison Report</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Current vs. Historical Intrinsic Values</p>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'scanner:export_all_history' %}"
                   class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export All CSV
                </a>
                <a href="{% url 'scanner:valuations' %}"
                   class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    Back to Valuations
                </a>
            </div>
        </div>
    </div>

    <!-- Comparison Dates Info -->
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
        <div class="flex items-start">
            <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <p class="text-sm text-blue-800 dark:text-blue-300">
                    <strong>Previous Quarter:</strong> {{ comparison_date_quarter|date:"M d, Y" }} &nbsp;&nbsp;|&nbsp;&nbsp;
                    <strong>Year Ago:</strong> {{ comparison_date_year|date:"M d, Y" }}
                </p>
                <p class="text-xs text-blue-700 dark:text-blue-400 mt-1">
                    Comparing current intrinsic values to historical quarterly snapshots. Deltas calculated using preferred valuation method.
                </p>
            </div>
        </div>
    </div>

    <!-- Current Intrinsic Values Bar Chart -->
    {% if chart_data_json %}
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Current Intrinsic Values by Method</h2>
        <div class="relative" style="height: 400px;">
            <canvas id="comparisonChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Comparison Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Stock
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Current Value
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Previous Quarter
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Quarter Change
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Year Ago
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Year Change
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {% for data in stocks %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <!-- Stock Symbol -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="{% url 'scanner:stock_history' data.stock.symbol %}"
                           class="text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">
                            {{ data.stock.symbol }}
                        </a>
                    </td>

                    <!-- Current Value -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">
                        {% if data.current_value %}${{ data.current_value }}{% else %}-{% endif %}
                    </td>

                    <!-- Previous Quarter Value -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                        {% if data.quarter_value %}${{ data.quarter_value }}{% else %}-{% endif %}
                    </td>

                    <!-- Quarter Change (Delta + %) -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if data.quarter_delta is not None %}
                            <div class="flex items-center gap-2">
                                {% if data.quarter_delta > 0 %}
                                    <span class="text-green-600 dark:text-green-400 font-medium">
                                        +${{ data.quarter_delta }}
                                    </span>
                                    <span class="text-xs text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30 px-2 py-0.5 rounded">
                                        +{{ data.quarter_pct|floatformat:2 }}%
                                    </span>
                                {% elif data.quarter_delta < 0 %}
                                    <span class="text-red-600 dark:text-red-400 font-medium">
                                        ${{ data.quarter_delta }}
                                    </span>
                                    <span class="text-xs text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/30 px-2 py-0.5 rounded">
                                        {{ data.quarter_pct|floatformat:2 }}%
                                    </span>
                                {% else %}
                                    <span class="text-gray-600 dark:text-gray-400">$0.00</span>
                                    <span class="text-xs text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded">
                                        0.00%
                                    </span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="text-gray-400 dark:text-gray-500 text-xs">No data</span>
                        {% endif %}
                    </td>

                    <!-- Year Ago Value -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                        {% if data.year_value %}${{ data.year_value }}{% else %}-{% endif %}
                    </td>

                    <!-- Year Change (Delta + %) -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if data.year_delta is not None %}
                            <div class="flex items-center gap-2">
                                {% if data.year_delta > 0 %}
                                    <span class="text-green-600 dark:text-green-400 font-medium">
                                        +${{ data.year_delta }}
                                    </span>
                                    <span class="text-xs text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30 px-2 py-0.5 rounded">
                                        +{{ data.year_pct|floatformat:2 }}%
                                    </span>
                                {% elif data.year_delta < 0 %}
                                    <span class="text-red-600 dark:text-red-400 font-medium">
                                        ${{ data.year_delta }}
                                    </span>
                                    <span class="text-xs text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/30 px-2 py-0.5 rounded">
                                        {{ data.year_pct|floatformat:2 }}%
                                    </span>
                                {% else %}
                                    <span class="text-gray-600 dark:text-gray-400">$0.00</span>
                                    <span class="text-xs text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded">
                                        0.00%
                                    </span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="text-gray-400 dark:text-gray-500 text-xs">No data</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                        No comparison data available.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Legend -->
    <div class="mt-6 bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Legend</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-600 dark:text-gray-400">
            <div class="flex items-center gap-2">
                <span class="text-green-600 dark:text-green-400">●</span>
                <span>Green indicates positive change (value increased)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-red-600 dark:text-red-400">●</span>
                <span>Red indicates negative change (value decreased)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-gray-600 dark:text-gray-400">●</span>
                <span>Dash (-) indicates no historical snapshot exists</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-blue-600 dark:text-blue-400">●</span>
                <span>Click stock symbol to view full history</span>
            </div>
        </div>
    </div>
</div>

{% if chart_data_json %}
<script>
  // Initialize Chart.js with bar chart data
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    const chartData = {{ chart_data_json|safe }};

    // Get computed colors from the actual page styles
    const computedStyle = window.getComputedStyle(document.body);
    const bgColor = computedStyle.backgroundColor;

    // Detect if we're in dark mode by checking background lightness
    const isDark = bgColor.includes('rgb') &&
                   parseInt(bgColor.split(',')[0].replace(/[^\d]/g, '')) < 128;

    const textColor = isDark ? '#f9fafb' : '#1f2937';
    const gridColor = isDark ? '#4b5563' : '#d1d5db';

    new Chart(ctx, {
      type: 'bar',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          title: {
            display: false,
          },
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: textColor,
              usePointStyle: true,
              padding: 15,
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += '$' + context.parsed.y.toFixed(2);
                }
                return label;
              }
            }
          }
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: 'Stock Symbol',
              color: textColor
            },
            ticks: {
              color: textColor
            },
            grid: {
              color: gridColor
            }
          },
          y: {
            display: true,
            beginAtZero: false,
            title: {
              display: true,
              text: 'Intrinsic Value ($)',
              color: textColor
            },
            ticks: {
              color: textColor,
              callback: function(value) {
                return '$' + value.toFixed(0);
              }
            },
            grid: {
              color: gridColor
            }
          }
        }
      }
    });
  });
</script>
{% endif %}

{% endblock %}
