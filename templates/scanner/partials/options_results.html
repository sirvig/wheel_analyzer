{% load options_extras %}

<!-- Development Mode Warning Banner -->
{% if is_local_environment %}
<div class="p-4 mb-4 text-sm text-amber-800 rounded-lg bg-amber-50 dark:bg-gray-800 dark:text-amber-300 border border-amber-300 dark:border-amber-800" role="alert">
    <div class="flex items-center">
        <svg class="flex-shrink-0 inline w-4 h-4 me-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
        </svg>
        <span class="font-semibold me-2">Development Mode:</span>
        Options data may be stale. Scans ran outside regular market hours (9:30 AM - 4:00 PM ET).
    </div>
</div>
{% endif %}

<div class="mb-4">
    Last scan: {{ last_scan }}<br />
    {% if not is_local_environment %}
    NOTE: Scans only happen between 9:30-4:00 EST on trading days.<br />
    {% endif %}
</div>

{% if ticker_options %}
<p class="mb-4">The following tickers have PUT options with a delta of .20 or less and an annualized return of 30% or more.</p>
{% else %}
<p class="mb-4">No options found.</p>
{% endif %}

<div id="accordion-collapse" data-accordion="collapse">
{% for ticker, options in ticker_options.items %}
  <h2 id="accordion-collapse-heading-{{ forloop.counter }}">
    <button type="button" class="flex items-center justify-between w-full p-5 font-medium rtl:text-right text-gray-500 border border-b-0 border-gray-200 rounded-t-xl focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-800 dark:border-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 gap-3" data-accordion-target="#accordion-collapse-body-{{ forloop.counter }}" aria-expanded="false" aria-controls="accordion-collapse-body-{{ forloop.counter }}">
      <span class="flex items-center gap-2">
        {# Stock-level badge #}
        {% with stock=curated_stocks|dict_get:ticker %}
          {% if stock %}
            {% with iv=stock.get_effective_intrinsic_value %}
              {% if iv is None %}
                <span class="inline-flex items-center px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">⚠</span>
              {% else %}
                {% check_good_options options iv as has_good_option %}
                {% if has_good_option %}
                  <span class="inline-flex items-center px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">✓</span>
                {% else %}
                  <span class="inline-flex items-center px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">✗</span>
                {% endif %}
              {% endif %}
            {% endwith %}
          {% else %}
            <span class="inline-flex items-center px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-200 rounded-full">-</span>
          {% endif %}
        {% endwith %}
        {{ ticker }} - last scan: {{ ticker_scan|lookup:ticker }}
      </span>
      <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
      </svg>
    </button>
  </h2>
  <div id="accordion-collapse-body-{{ forloop.counter }}" class="hidden" aria-labelledby="accordion-collapse-heading-{{ forloop.counter }}">
    <div class="p-5 border border-b-0 border-gray-200 dark:border-gray-700 dark:bg-gray-900">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-2 py-2">Status</th>
                    <th scope="col" class="px-2 py-2">Date</th>
                    <th scope="col" class="px-2 py-2">Strike</th>
                    <th scope="col" class="px-2 py-2">Price</th>
                    <th scope="col" class="px-2 py-2">Change</th>
                    <th scope="col" class="px-2 py-2">Delta</th>
                    <th scope="col" class="px-2 py-2">Annualized</th>
                    <th scope="col" class="px-2 py-2">IV</th>
                </tr>
            </thead>
            <tbody>
            {% for option in options %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                    <td class="px-2 py-2">
                      {# Option-level badge #}
                      {% with stock=curated_stocks|dict_get:ticker %}
                        {% if stock %}
                          {% with iv=stock.get_effective_intrinsic_value %}
                            {% if iv is None %}
                              <span class="inline-flex items-center px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">⚠ N/A</span>
                            {% elif option.strike <= iv %}
                              <span class="inline-flex items-center px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">✓ Good</span>
                            {% else %}
                              <span class="inline-flex items-center px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">✗ High</span>
                            {% endif %}
                          {% endwith %}
                        {% else %}
                          <span class="inline-flex items-center px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-200 rounded-full">-</span>
                        {% endif %}
                      {% endwith %}
                    </td>
                    <td class="px-2 py-2">{{ option.date }}</td>
                    <td class="px-2 py-2">${{ option.strike }}</td>
                    <td class="px-2 py-2">${{ option.price|floatformat:2 }}</td>
                    <td class="px-2 py-2">{{ option.change|floatformat:2 }}%</td>
                    <td class="px-2 py-2">{{ option.delta|floatformat:2 }}</td>
                    <td class="px-2 py-2">{{ option.annualized|floatformat:2 }}%</td>
                    <td class="px-2 py-2">{{ option.iv|floatformat:2 }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
  </div>
{% endfor %}
</div>
